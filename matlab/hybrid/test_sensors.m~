% reading sensors for testing
instrreset % reset all serial ports
clear all;
close all;
clc;

camera = webcam('/dev/video3'); % camera for testing
grideyeName = '/dev/ttyUSB0'; % grideye data
dataPortName = '/dev/ttyUSB2'; % mmwave data
controlPortName = '/dev/ttyUSB1'; % mmwave control

dataFilename = 'test_data/scenario1_trial1.mat';
photoFilename = 'test_photos/scenario1_trial1/photo#%d.png';

% initialize mmwave
[dataPort, controlPort, params, scene, wall, cfgData] = mmwave_initialize(dataPortName, controlPortName);

% initialize grideye and wait on USB line
s = grideye_initialize(grideyeName);
while s.BytesAvailable == 0
    % wait for PIR signal
end

% n measurements, taken k seconds apart
n = 20;
k = .5;

% people reported on each measurement, with snapshot taken
% 1st index is number of people detected
% 2nd/3rd index are xy-coord of 1st target
% 4th/5th index are xy-coord of 2nd target
% 6th/7th index are xy-coord of 2nd target
% assume no more than 3 targets will be detected; all initialized to 0
data = zeros(7, n);

% begin reading grideye data
m = 0; % used to track number of grideye measurements before mmwave triggered
for i=1:n
    % take photo for evaluation
    image = snapshot(camera);
    imageFile = sprintf(photoFilename, i); % save camera image
    imwrite(image, imageFile);
    
    % read grideye data
    data_grid = rot90(grideye_read(s));% - noise);
    
    % count people
    [num_people, coordinates] = grideye_count(data_grid);
    data(1, i) = num_people; % store num detected people of frame
    for j=0:2
        if j > num_people
        
        data(2*j+2, i) = coordinates(j+1); % store x-coord of people (depth is not tracked for grideye)
    end
    
    data(2, i) = coordinates(1); % x position
    data(3, i) = -1; % arbitrarily set depth to -1
    m = m + 1;

    if num_people > 0
        % show people's x-position
        for j = 1:num_people
            fprintf("person %d, x-coord: %d\n", j, coordinates(j, 1));
        end
       break; % begin mmwave if grideye detects someone
    end
    
    % wait for next reading
    pause(k);
end

% read data from mmwave and store in results vector
mmwave_read(dataPort, controlPort, params, scene, wall, cfgData, data, m, n, k, camera, photoFilename);

save(datafileName, 'data'); % save results